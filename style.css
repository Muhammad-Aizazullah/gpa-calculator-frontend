document.addEventListener('DOMContentLoaded', () => {
    const gpaDisplay = document.getElementById('gpaDisplay');
    const courseList = document.getElementById('courseList');
    const gpaForm = document.getElementById('gpaForm');
    const resetBtn = document.getElementById('resetBtn');
    const resultDisplay = document.getElementById('result');

    const API_BASE = ''; // Leave blank for same-origin or use full URL if hosted separately

    async function fetchCourses() {
        const response = await fetch(`${API_BASE}/courses`);
        const data = await response.json();

        courseList.innerHTML = '';
        data.forEach(course => {
            const li = document.createElement('li');
            li.textContent = `${course.course_name} (${course.credit_hours} cr) - ${course.grade}`;
            courseList.appendChild(li);
        });
    }

    async function fetchGPA() {
        const priorGPA = document.getElementById('priorGPA').value || 0;
        const completedCredits = document.getElementById('completedCredits').value || 0;

        const response = await fetch(`${API_BASE}/gpa?prior_gpa=${priorGPA}&completed_credits=${completedCredits}`);
        const data = await response.json();

        gpaDisplay.textContent = `Your GPA: ${data.gpa.toFixed(2)}`;
    }

    gpaForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const course = document.getElementById('course').value;
        const credit = document.getElementById('credit').value;
        const grade = document.getElementById('grade').value;

        if (!course || !credit || !grade) {
            resultDisplay.textContent = 'Please fill in all fields.';
            resultDisplay.classList.remove('success');
            resultDisplay.classList.add('error');
            resultDisplay.style.display = 'block';
            return;
        }

        const response = await fetch(`${API_BASE}/courses`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ course, credit, grade })
        });

        const data = await response.json();

        if (response.ok) {
            resultDisplay.textContent = data.message;
            resultDisplay.classList.remove('error');
            resultDisplay.classList.add('success');
            resultDisplay.style.display = 'block';

            gpaForm.reset();
            await fetchCourses();
            await fetchGPA();
        } else {
            resultDisplay.textContent = data.error || 'An error occurred.';
            resultDisplay.classList.remove('success');
            resultDisplay.classList.add('error');
            resultDisplay.style.display = 'block';
        }
    });

    resetBtn.addEventListener('click', async () => {
        const response = await fetch(`${API_BASE}/reset`, {
            method: 'POST'
        });

        const data = await response.json();

        if (response.ok) {
            resultDisplay.textContent = data.message;
            resultDisplay.classList.remove('error');
            resultDisplay.classList.add('success');
            resultDisplay.style.display = 'block';

            await fetchCourses();
            gpaDisplay.textContent = '';
        }
    });

    // Initial fetch
    fetchCourses();
    fetchGPA();
});
